name: Automated test api

on:
  workflow_dispatch:

env:
  lean_token: ${{ secrets.LEAN_TOKEN }}

jobs:
  test:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v3
      - name: Setup Python
        uses: actions/setup-python@v4
        with:
          python-version: "3.10"
      - name: Install dependencies
        run: pip install -r requirements.txt
      - name: Run tests
        run: pytest -v

      - name: Load test report history
          uses: actions/checkout@v3
          if: always()
          continue-on-error: true
          with:
            ref: gh-pages
            path: gh-pages

      - name: Build test report
          uses: simple-elf/allure-report-action@v1.7
          if: always()
          with:
            gh_pages: gh-pages
            allure_history: allure-history
            allure_results: build/allure-results

      - name: Publish test report
          uses: peaceiris/actions-gh-pages@v3
          if: always()
          with:
            github_token: ${{ secrets.GITHUB_TOKEN }}
            publish_branch: gh-pages
            publish_dir: allure-history



